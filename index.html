<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Spin the Wheel: The Wheel of Friends</title>
    <link rel="icon" href="/images/spin.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- Your existing styles -->
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #1a1a1a;
            color: #f0f0f0;
            font-family: 'Poppins', sans-serif;
            text-align: center;
            overflow: hidden;
        }

        h1 {
            font-size: 3em;
            letter-spacing: 5px;
            text-transform: uppercase;
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }

        #spin_the_wheel {
            display: inline-block;
            position: relative;
            overflow: hidden;
            margin-bottom: 20px;
        }

        #wheel {
            display: block;
            border: 8px solid #555;
            border-radius: 50%;
            background: #2c2c2c;
            box-shadow: 0 0 50px rgba(255, 255, 255, 0.1);
        }

        #spin {
            font-size: 1.5em;
            font-weight: 700;
            user-select: none;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30%;
            height: 30%;
            margin: -15%;
            background: linear-gradient(45deg, #ff5722, #f53a1a);
            color: #fff;
            box-shadow:
                0 0 0 8px #fff,
                0 5px 15px rgba(255, 87, 34, 0.4);
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        #spin:hover {
            transform: scale(1.05);
            box-shadow:
                0 0 0 8px #fff,
                0 8px 25px rgba(255, 87, 34, 0.6);
        }

        #spin::after {
            content: "";
            position: absolute;
            top: -12px;
            border: 8px solid transparent;
            border-bottom-color: #fff;
            border-top: none;
        }

        #result {
            font: bold 2em 'Poppins', sans-serif;
            letter-spacing: 3px;
            color: #ffeb3b;
            text-shadow: 0 0 10px #ffeb3b, 0 10 20px #ffeb3b;
            opacity: 0;
            transition: opacity 1s ease-in-out;
            margin-top: 20px;
        }

        #result.show {
            opacity: 1;
        }
    </style>
</head>

<body>
    <h1>ðŸŽ¯ The Wheel of Fate</h1>

    <div id="spin_the_wheel">
        <canvas id="wheel" width="500" height="500"></canvas>
        <div id="spin">SPIN</div>
    </div>

    <div id="result"></div>

    <script type="module">
        // Import Firebase modules using the modern v9+ syntax
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, runTransaction } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyATBz4evBmC02HEjKyFvrwg_rD8Ep-2SgY",
            authDomain: "truthgame-eff96.firebaseapp.com",
            projectId: "truthgame-eff96",
            storageBucket: "truthgame-eff96.firebasestorage.app",
            messagingSenderId: "559726354658",
            appId: "1:559726354658:web:a5d7a2835777d8b5e6febb",
            measurementId: "G-9M5KPG6HHS"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);
        const gameStateRef = ref(database, 'gameState');

        // Game logic starts here
        const sectors = [
            { color: "#800020", text: "#fff", label: "Sonu" },
            { color: "#36454F", text: "#fff", label: "Mouni" },
            { color: "#228B22", text: "#fff", label: "Shyam" },
            { color: "#000080", text: "#fff", label: "Sampath" },
        ];

        const events = {
            listeners: {},
            addListener: function (eventName, fn) {
                this.listeners[eventName] = this.listeners[eventName] || [];
                this.listeners[eventName].push(fn);
            },
            fire: function (eventName, ...args) {
                if (this.listeners[eventName]) {
                    for (let fn of this.listeners[eventName]) {
                        fn(...args);
                    }
                }
            },
        };

        const rand = (m, M) => Math.random() * (M - m) + m;
        const tot = sectors.length;
        const spinEl = document.querySelector("#spin");
        const ctx = document.querySelector("#wheel").getContext("2d");
        const resultEl = document.querySelector("#result");

        const dia = ctx.canvas.width;
        const rad = dia / 2;
        const PI = Math.PI;
        const TAU = 2 * PI;
        const arc = TAU / sectors.length;

        let angVel = 0;
        let ang = 0;
        let isSpinning = false; // Add a state variable to prevent multiple spins

        const getIndex = () => Math.floor(tot - (ang / TAU) * tot) % tot;

        function drawSector(sector, i) {
            const ang = arc * i;
            ctx.save();
            ctx.beginPath();
            ctx.fillStyle = sector.color;
            ctx.moveTo(rad, rad);
            ctx.arc(rad, rad, rad, ang, ang + arc);
            ctx.lineTo(rad, rad);
            ctx.fill();
            ctx.translate(rad, rad);
            ctx.rotate(ang + arc / 2);
            ctx.textAlign = "right";
            ctx.fillStyle = sector.text;
            ctx.font = "bold 20px 'Poppins', sans-serif";
            ctx.fillText(sector.label, rad - 5, 5);
            ctx.restore();
        }

        function rotate() {
            const sector = sectors[getIndex()];
            ctx.canvas.style.transform = `rotate(${ang - PI / 2}rad)`;
            if (angVel > 0) {
                spinEl.textContent = sector.label;
                spinEl.style.background = sector.color;
                spinEl.style.color = sector.text;
            }
        }

        // This function starts the wheel animation and handles deceleration
        function startSpin(finalWinner) {
            if (isSpinning) return; // Prevent new spins while one is in progress
            isSpinning = true;

            resultEl.classList.remove('show');
            resultEl.textContent = '';

            const winnerIndex = sectors.findIndex(s => s.label === finalWinner);
            if (winnerIndex === -1) {
                console.error("Winner not found in sectors array.");
                isSpinning = false;
                return;
            }

            // Calculate the target angle for the wheel
            const finalAng = TAU - (arc * winnerIndex) - arc / 2;
            const extraSpins = rand(10, 15) * TAU; // 10-15 extra full rotations
            const targetAng = finalAng + extraSpins;

            angVel = rand(0.25, 0.45);
            ang = 0;

            function animateSpin() {
                angVel *= 0.991; // Apply friction
                ang += angVel;

                if (angVel < 0.002) {
                    ang = targetAng % TAU; // Snap to the final position for perfect alignment
                    rotate();
                    const finalSector = sectors[getIndex()];
                    events.fire("spinEnd", finalSector);
                    isSpinning = false;
                    return;
                }

                rotate();
                requestAnimationFrame(animateSpin);
            }
            animateSpin();
        }

        function init() {
            sectors.forEach(drawSector);
            rotate();

            // When the spin button is clicked, start a transaction
            spinEl.addEventListener("click", () => {
                if (!isSpinning) {
                    spinEl.textContent = "SPINNING...";

                    // Use a transaction to safely update the database
                    runTransaction(gameStateRef, (currentData) => {
                        // If the database is currently null or not spinning, set a new winner
                        if (currentData === null || !currentData.isSpinning) {
                            const randomWinner = sectors[Math.floor(Math.random() * sectors.length)].label;
                            return {
                                winner: randomWinner,
                                isSpinning: true,
                                spinTimestamp: Date.now()
                            };
                        } else {
                            // If a spin is already in progress, abort the transaction
                            return undefined;
                        }
                    })
                        .then((result) => {
                            if (!result.committed) {
                                console.log("Spin already in progress, aborting.");
                                spinEl.textContent = "SPIN";
                            }
                        })
                        .catch(error => {
                            console.error("Error during transaction:", error);
                            spinEl.textContent = "SPIN";
                        });
                }
            });
        }

        // Listen for real-time updates from Firebase
        onValue(gameStateRef, (snapshot) => {
            const data = snapshot.val();
            if (data && data.winner) {
                startSpin(data.winner);
            }
        });

        init();

        events.addListener("spinEnd", (sector) => {
            resultEl.textContent = `ðŸŽ‰ The chosen one is ${sector.label}! ðŸŽ‰`;
            resultEl.classList.add('show');
            spinEl.textContent = "SPIN";
            spinEl.style.background = sector.color;
            spinEl.style.color = sector.text;

            // After the spin, set the isSpinning flag back to false in the database
            runTransaction(gameStateRef, (currentData) => {
                if (currentData !== null) {
                    currentData.isSpinning = false;
                }
                return currentData;
            });
        });
    </script>
</body>

</html>